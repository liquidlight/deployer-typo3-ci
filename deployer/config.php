<?php

namespace Deployer;

/**
 * driver_typo3cms
 * @package deployer-extended-typo3
 *
 * Use typo3 as the driver - will get db details from typo3cms command
 */
set('driver_typo3cms', true);

/**
 * repository
 * @package deployer
 *
 * Set the repository URL - this is generated by Gitlab CI to include a deploy token
 */
if (getenv('CI_REPOSITORY_URL')) {
	set('repository', getenv('CI_REPOSITORY_URL'));
}

/**
 * local_host
 *
 * @package deployer-extended-database
 *
 * If you just run "deploy" what happens?
 *
 * Check if file doesn't exist - e.g. deploying via CI
 * This is needed for the database backup
 */
if (!file_exists(getcwd() . '/.env')) {
	set('local_host', 'local');
}


/**
 * keep_releases
 * @package deployer
 *
 * How many releases to keep
 */
set('keep_releases', 3);

/**
 * writable_mode
 * @package deployer
 *
 * What writeable mode should we use?
 */
set('writable_mode', 'chmod');

/**
 * writable_chmod_mode
 * @package deployer
 *
 * What permissions should "writable_dirs" have?
 */
set('writable_chmod_mode', '0775');

/**
 * writable_recursive
 * @package deployer
 *
 * Use recursive mode (-R)?
 */
set('writable_recursive', true);

/**
 * writable_dirs
 * @package deployer
 *
 * Which folders are writeable?
 */
set(
	'writable_dirs',
	[
		'var',
		get('web_path') . 'typo3conf',
		get('web_path') . 'typo3temp',
		get('web_path') . 'uploads',
		get('web_path') . 'fileadmin',
	]
);

/**
 * media_allow_*
 * @package deployer-extended-media
 *
 * Do not allow dangerous media sync to top instances.
 * Look https://github.com/sourcebroker/deployer-extended-media for docs
 */
set('media_allow_push_live', false);
set('media_allow_copy_live', false);
set('media_allow_link_live', false);
set('media_allow_pull_live', false);

/**
 * db_allow_*
 * @package deployer-extended-db
 *
 * Do not allow dangerous database sync to top instances.
 * Look https://github.com/sourcebroker/deployer-extended-database
 */
set('db_allow_push_live', false);
set('db_allow_pull_live', false);
set('db_allow_copy_live', false);

/**
 * db_databases_merged
 * @package deployer-extended-db
 *
 * Extend ignore_tables_out defined in sourcebroker/deployer-typo3-database
 */
$dbDatabaseMerged = get('db_default');
$dbDatabaseMerged['ignore_tables_out'] = [
	...$dbDatabaseMerged['ignore_tables_out'],
	'sys_history',
	'sys_log',
	'tx_powermail_domain_model_mail',
	'tx_powermail_domain_model_answer',
	'tx_kesearch_stat_word',
	'tx_kesearch_stat_search',
];
set('db_default', $dbDatabaseMerged);


/**
 * clear_paths
 * @package deployer
 *
 * What folders get removed from live?
 */
set(
	'clear_paths',
	array_merge(
		get('clear_paths'),
		[
			'.env.example',
			'.gitlab/',
			'bearer.yml',
			'build/',
			'ec-cli-config.php',
			'gulpfile.js',
			'gulpfile.mjs',
			'Makefile',
			'package-lock.json',
			'package.json',
			'playwright.config.ts',
			'README.md',
			'app/*/*/package.json',
			'app/**/*.test.ts',
			'app/**/*.spec.ts',
		]
	)
);
